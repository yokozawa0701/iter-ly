---
import '../styles/global.css';
import Header from '../components/parts/Header.astro';
import LineFloatingButton from '../components/parts/LineFloatingButton.astro';

interface Props {
  title: string;
  description?: string;
  keywords?: string;
  ogImage?: string;
  canonicalUrl?: string;
}

const { title, description, keywords, ogImage, canonicalUrl } = Astro.props;
const gtmId = import.meta.env.PUBLIC_GTM_ID;
const siteUrl = 'https://www.iter-ly.com';
const resolvedCanonical = canonicalUrl || siteUrl + Astro.url.pathname;
const resolvedOgImage = ogImage || siteUrl + '/og-image.png';
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <link
      rel="preload"
      href="/images/hero-sp.webp"
      as="image"
      type="image/webp"
      media="(max-width: 767px)"
    />
    <link
      rel="preload"
      href="/images/hero-pc.webp"
      as="image"
      type="image/webp"
      media="(min-width: 768px)"
    />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    {keywords && <meta name="keywords" content={keywords} />}
    <link rel="canonical" href={resolvedCanonical} />

    <!-- OGP -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={resolvedCanonical} />
    <meta property="og:image" content={resolvedOgImage} />
    <meta property="og:site_name" content="イテリー" />
    <meta property="og:locale" content="ja_JP" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    {description && <meta name="twitter:description" content={description} />}
    <meta name="twitter:image" content={resolvedOgImage} />

    <!-- GTM (deferred) -->
    <script is:inline define:vars={{ gtmId }}>
      if (gtmId) {
        var loadGTM = function () {
          (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
            var f = d.getElementsByTagName(s)[0],
              j = d.createElement(s),
              dl = l != 'dataLayer' ? '&l=' + l : '';
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
          })(window, document, 'script', 'dataLayer', gtmId);
        };
        if ('requestIdleCallback' in window) {
          requestIdleCallback(loadGTM);
        } else {
          setTimeout(loadGTM, 2000);
        }
      }
    </script>
  </head>
  <body>
    {
      gtmId && (
        <noscript>
          <iframe
            src={`https://www.googletagmanager.com/ns.html?id=${gtmId}`}
            height="0"
            width="0"
            style="display:none;visibility:hidden"
          />
        </noscript>
      )
    }
    <Header />
    <slot />
    <footer class="bg-gray-900 py-6 text-center text-sm text-gray-400">
      <div class="mb-2 flex justify-center gap-4">
        <a href="/legal" class="underline hover:text-gray-300"
          >特定商取引法に基づく表記</a
        >
        <a href="/privacy" class="underline hover:text-gray-300"
          >プライバシーポリシー</a
        >
      </div>
      <p>&copy; 2026 Maaji inc.</p>
    </footer>
    <LineFloatingButton />
  </body>
</html>
